package github.com/hashicorp/terraform-provider-azurerm/internal/tools/document-lint/check
import (
	"fmt"
	"log"
	"os"
	"path"
	"path/filepath"
	"sort"
	"strings"
	"sync"

	"github.com/fatih/color"
	"github.com/hashicorp/terraform-provider-azurerm/internal/tools/document-lint/md"
	"github.com/hashicorp/terraform-provider-azurerm/internal/tools/document-lint/model"
	"github.com/hashicorp/terraform-provider-azurerm/internal/tools/document-lint/schema"
	"github.com/hashicorp/terraform-provider-azurerm/internal/tools/document-lint/util"
)
func diffField(r *schema.Resource, mdField *model.Field, xPath []string) (res []Checker) {
	fullPath := strings.Join(xPath, ".")
	if isSkipProp(r.ResourceType, fullPath) {
		return
	}

	// if end property
	if mdField.Subs == nil {
		wanted := r.PossibleValues[fullPath]
		docVal := mdField.PossibleValues()
		if missed, spare := SliceDiff(wanted, docVal, true); len(missed)+len(spare) > 0 {
			// Check if this property has version changes before reporting error
			// Skip possible value diff if this property has changes in new version upgrade.
			// This is because it's not consistent whether possible values change should be documented or not when it's in the upgrade feature flag
			if hasVersionChanges(r.ResourceType, fullPath) {
				log.Printf("[SKIP] %s.%s: Skipping possible values validation due to version changes detected in upgrade guide (missed: %v, spare: %v)",
					r.ResourceType, fullPath, missed, spare)
				return
			}

			if !mayExistsInDoc(mdField.Content, wanted) {
				base := newCheckBase(mdField.Line, fullPath, mdField)
				res = append(res, newPossibleValueDiff(base, wanted, docVal, missed, spare))
			}
		}
		return
	}
	// check if r has such path
	if !r.HasPathFor(xPath) {
		log.Printf("%s %s has no path [%s], there must be an error in markdwon", color.YellowString("[WARN]"), r.ResourceType, strings.Join(xPath, "."))
		return
	}
	for _, sub := range mdField.Subs {
		subRes := diffField(r, sub, append(xPath, sub.Name))
		res = append(res, subRes...)
	}
	return
}
