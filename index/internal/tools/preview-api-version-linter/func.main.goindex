package github.com/hashicorp/terraform-provider-azurerm/internal/tools/main
import (
	"fmt"
	"os"
	"path/filepath"
	"sort"
	"strings"

	"github.com/hashicorp/terraform-provider-azurerm/internal/tools/preview-api-version-linter/sdk"
	"github.com/hashicorp/terraform-provider-azurerm/internal/tools/preview-api-version-linter/version"
)
func main() {
	historicalExceptions, err := version.ParseHistoricalExceptions(filepath.FromSlash(HISTORICAL_EXCEPTIONS_FILE))
	if err != nil {
		fmt.Fprintf(os.Stderr, "failed to parse historical exceptions file %s:\n\n%s\n\n", HISTORICAL_EXCEPTIONS_FILE, err)
		printErrorFooterAndExit()
	}
	exceptions, err := version.ParseExceptions(filepath.FromSlash(EXCEPTIONS_FILE))
	if err != nil {
		fmt.Fprintf(os.Stderr, "failed to parse exceptions file %s:\n\n%s\n\n", EXCEPTIONS_FILE, err)
		printErrorFooterAndExit()
	}

	previewVersions := map[version.Version]bool{}
	for _, sdkType := range sdk.SdkTypes {
		if err := populatePreviewVersions(sdkType, previewVersions); err != nil {
			fmt.Fprintf(os.Stderr, "failed to populate preview versions for SDK type %s:\n\n%s\n\n", sdkType.Module, err)
			printErrorFooterAndExit()
		}
	}

	unusedExceptions := []string{}
	for _, exception := range historicalExceptions {
		if !previewVersions[exception] {
			unusedExceptions = append(unusedExceptions, fmt.Sprintf("module: %s, service: %s, version: %s", exception.Module, exception.Service, exception.Version))
		} else {
			delete(previewVersions, exception)
		}
	}
	failIfAnyUnusuedExceptions(unusedExceptions, HISTORICAL_EXCEPTIONS_FILE)

	for _, exception := range exceptions {
		if !previewVersions[exception] {
			unusedExceptions = append(unusedExceptions, fmt.Sprintf("module: %s, service: %s, version: %s", exception.Module, exception.Service, exception.Version))
		} else {
			delete(previewVersions, exception)
		}
	}
	failIfAnyUnusuedExceptions(unusedExceptions, EXCEPTIONS_FILE)

	if len(previewVersions) > 0 {
		invalidPreviewVersions := []string{}
		for svcVer := range previewVersions {
			invalidPreviewVersions = append(invalidPreviewVersions, fmt.Sprintf("module: %s, service: %s, version: %s", svcVer.Module, svcVer.Service, svcVer.Version))
		}
		sort.Strings(invalidPreviewVersions)

		fmt.Fprintf(os.Stderr, "❌ Invalid use of preview ARM API versions detected in `vendor` folder:\n\n")
		for _, v := range invalidPreviewVersions {
			fmt.Fprintf(os.Stderr, "%s\n", v)
		}
		fmt.Fprintf(os.Stderr, `
Preview versions are prone to sudden breaking changes which can result in a less than ideal user experience,
please use stable version instead.

`)
		printErrorFooterAndExit()
	}

	fmt.Printf("✅ No invalid use of preview ARM API versions detected in %s folder.\n", VENDOR_DIR)
}
